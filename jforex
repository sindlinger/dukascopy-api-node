#!/usr/bin/env bash
set -euo pipefail

# ------------------------------------------------------------
# JForex "stack" wrapper:
# - Start/stop/status/logs do servidor (jforex-websocket-api-*.jar)
# - Encaminha qualquer outro comando para o CLI (jforex.jar / jforexctl.jar)
#
# Estrutura esperada (mesma pasta do script):
#   ./jforex                         (este script)
#   ./jforex.jar                     (CLI robusto)
#   ./jforex-websocket-api-1.0.0.jar (servidor)
#   ./.env                           (credenciais/config do servidor)
#
# Uso:
#   ./jforex init
#   ./jforex up
#   ./jforex instruments list
#   ./jforex ws tail --type tick --instrument EURUSD --limit 20 --pretty
#   ./jforex logs
#   ./jforex down
# ------------------------------------------------------------

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Permite override por env
CLI_JAR="${JFOREX_CLI_JAR:-$DIR/jforex.jar}"
if [[ ! -f "$CLI_JAR" ]]; then
  # fallback para jforexctl.jar (caso você esteja usando a versão mínima)
  if [[ -f "$DIR/jforexctl.jar" ]]; then
    CLI_JAR="$DIR/jforexctl.jar"
  fi
fi

# auto-detect do server jar na pasta (se env não setar)
SERVER_JAR="${JFOREX_SERVER_JAR:-}"
if [[ -z "${SERVER_JAR}" ]]; then
  # pega o primeiro que casar, ignorando .old.jar e .original
  SERVER_JAR="$(ls -1 "$DIR"/jforex-websocket-api-*.jar 2>/dev/null \
    | grep -vE '\.old\.jar$|\.jar\.original$|\.original$' \
    | head -n1 || true)"
fi

ENV_FILE="${JFOREX_ENV_FILE:-$DIR/.env}"
CONFIG_FILE="${JFOREX_CONFIG_FILE:-$DIR/jforex.properties}"

RUN_DIR="$DIR/run"
LOG_DIR="$DIR/logs"
PID_FILE="$RUN_DIR/server.pid"
LOG_FILE="$LOG_DIR/server.log"

# Defaults (podem ser sobrescritos por config/env/args)
DEFAULT_PORT="${JFOREX_SERVER_PORT:-8080}"
DEFAULT_WS_PATH="${JFOREX_WS_PATH:-/ws/market}"

die() { echo "Erro: $*" >&2; exit 1; }

require_cmd() {
  command -v "$1" >/dev/null 2>&1 || die "Comando nao encontrado no PATH: $1"
}

require_java() {
  require_cmd java
}

ensure_cli_jar() {
  [[ -f "$CLI_JAR" ]] || die "Nao achei o CLI jar. Esperado em: $CLI_JAR (ou defina JFOREX_CLI_JAR)"
}

ensure_server_jar() {
  [[ -n "$SERVER_JAR" && -f "$SERVER_JAR" ]] || die "Nao achei o server jar (jforex-websocket-api-*.jar) na pasta. Coloque-o aqui ou defina JFOREX_SERVER_JAR"
}

# Carrega .env exportando variáveis (comentários e CRLF ok)
load_env() {
  if [[ -f "$ENV_FILE" ]]; then
    # shellcheck disable=SC1090
    set -a
    source <(sed 's/\r$//' "$ENV_FILE" | grep -vE '^\s*#' || true)
    set +a
  fi
}

is_running() {
  [[ -f "$PID_FILE" ]] || return 1
  local pid
  pid="$(cat "$PID_FILE" 2>/dev/null || true)"
  [[ -n "$pid" ]] || return 1
  kill -0 "$pid" 2>/dev/null
}

print_status() {
  if is_running; then
    local pid; pid="$(cat "$PID_FILE")"
    echo "RUNNING pid=$pid"
  else
    echo "STOPPED"
  fi
}

# Lê uma chave simples do config.properties (key=value)
cfg_get() {
  local key="$1"
  [[ -f "$CONFIG_FILE" ]] || return 1
  grep -E "^${key}=" "$CONFIG_FILE" 2>/dev/null | tail -n1 | sed -E "s/^${key}=//"
}

# Garante que existe config local (na mesma pasta) e ajusta host/ws/server.jar/port
init_config() {
  require_java
  ensure_cli_jar

  mkdir -p "$RUN_DIR" "$LOG_DIR"

  # init cria arquivo se não existir
  java -jar "$CLI_JAR" --config "$CONFIG_FILE" config init >/dev/null 2>&1 || true

  local port="${1:-$DEFAULT_PORT}"
  local host="http://localhost:${port}"
  local ws="ws://localhost:${port}${DEFAULT_WS_PATH}"

  # seta chaves mais úteis
  java -jar "$CLI_JAR" --config "$CONFIG_FILE" config set host "$host" >/dev/null
  java -jar "$CLI_JAR" --config "$CONFIG_FILE" config set ws   "$ws"   >/dev/null
  java -jar "$CLI_JAR" --config "$CONFIG_FILE" config set server.port "$port" >/dev/null

  if [[ -n "${SERVER_JAR:-}" && -f "${SERVER_JAR:-}" ]]; then
    java -jar "$CLI_JAR" --config "$CONFIG_FILE" config set server.jar "$SERVER_JAR" >/dev/null
  fi

  echo "OK"
  echo "Config local: $CONFIG_FILE"
  echo "  host=$host"
  echo "  ws=$ws"
  if [[ -n "${SERVER_JAR:-}" && -f "${SERVER_JAR:-}" ]]; then
    echo "  server.jar=$SERVER_JAR"
  fi
  echo "  server.port=$port"
}

write_env_template() {
  if [[ -f "$ENV_FILE" ]]; then
    echo "Ja existe: $ENV_FILE"
    return 0
  fi

  cat >"$ENV_FILE" <<'EOF'
# Credenciais Dukascopy / JForex
JFOREX_USER=SEU_USER
JFOREX_PASS=SUA_SENHA

# Instrumentos (pode usar EUR/USD ou EURUSD; o servidor normaliza)
JFOREX_INSTRUMENTS=EUR/USD,USD/JPY

# Profundidade do book L2
JFOREX_BOOK_DEPTH=10

# Opcional: JNLP
# JFOREX_JNLP=http://platform.dukascopy.com/live_3/jforex_3.jnlp
EOF

  echo "Criado template: $ENV_FILE"
  echo "Edite e preencha JFOREX_USER/JFOREX_PASS antes de subir o servidor."
}

cmd_init() {
  # Nao exige o server jar para criar template/config (mas se ele existir, sera gravado no config)
  write_env_template
  init_config "${1:-$DEFAULT_PORT}"
}

cmd_up() {
  require_java
  ensure_server_jar
  ensure_cli_jar

  local port="$DEFAULT_PORT"
  local extra_args=()

  # parse args: --port N e "--" para repassar args ao Spring
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --port)
        shift; port="${1:-}"; [[ -n "$port" ]] || die "Faltou valor para --port"
        shift;;
      --)
        shift
        extra_args+=("$@")
        break;;
      *)
        die "Opcao desconhecida em up: $1 (use: up [--port 8080] [-- <args spring>])";;
    esac
  done

  if is_running; then
    echo "Ja esta rodando."
    print_status
    exit 0
  fi

  mkdir -p "$RUN_DIR" "$LOG_DIR"

  # garante config coerente com a porta escolhida
  init_config "$port" >/dev/null || true

  # carrega .env (credenciais etc.)
  load_env

  # start em background
  echo "Iniciando servidor..."
  # shellcheck disable=SC2086
  nohup java ${JAVA_OPTS:-} -jar "$SERVER_JAR" --server.port="$port" "${extra_args[@]}" \
    >"$LOG_FILE" 2>&1 &

  echo $! >"$PID_FILE"

  # verificação rápida
  if ! kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
    echo "Falhou ao iniciar. Ultimas linhas do log:"
    tail -n 80 "$LOG_FILE" || true
    exit 1
  fi

  echo "OK"
  print_status
  echo "Log: $LOG_FILE"
  echo "REST: http://localhost:$port/api/instruments"
  echo "WS:   ws://localhost:$port${DEFAULT_WS_PATH}"
}

cmd_down() {
  if ! is_running; then
    echo "Nao esta rodando."
    exit 0
  fi
  local pid; pid="$(cat "$PID_FILE")"
  echo "Parando pid=$pid ..."
  kill "$pid" 2>/dev/null || true

  # espera curta
  for _ in {1..40}; do
    if ! kill -0 "$pid" 2>/dev/null; then
      rm -f "$PID_FILE"
      echo "OK"
      return 0
    fi
    sleep 0.1
  done

  echo "Nao encerrou a tempo; forçando (SIGKILL)."
  kill -9 "$pid" 2>/dev/null || true
  rm -f "$PID_FILE"
  echo "OK"
}

cmd_logs() {
  mkdir -p "$LOG_DIR"
  [[ -f "$LOG_FILE" ]] || { echo "Sem log ainda: $LOG_FILE"; exit 0; }
  tail -n 200 -f "$LOG_FILE"
}

usage() {
  cat <<EOF
Uso:
  ./jforex init [porta]
  ./jforex up [--port 8080] [-- <args spring>]
  ./jforex down
  ./jforex status
  ./jforex logs

Qualquer outro comando eh encaminhado para o CLI (jforex.jar):
  ./jforex instruments list
  ./jforex orderbook top --instrument EURUSD
  ./jforex ws tail --type tick --instrument EURUSD --limit 20 --pretty
  ./jforex config show
  ./jforex doctor

Arquivos usados (mesma pasta):
  CLI_JAR:     $CLI_JAR
  SERVER_JAR:  ${SERVER_JAR:-"(nao encontrado)"}
  CONFIG_FILE: $CONFIG_FILE
  ENV_FILE:    $ENV_FILE
  LOG_FILE:    $LOG_FILE
  PID_FILE:    $PID_FILE

Overrides por env:
  JFOREX_CLI_JAR, JFOREX_SERVER_JAR, JFOREX_CONFIG_FILE, JFOREX_ENV_FILE,
  JFOREX_SERVER_PORT, JFOREX_WS_PATH, JAVA_OPTS
EOF
}

main() {
  local cmd="${1:-help}"
  case "$cmd" in
    help|-h|--help)
      usage;;
    init)
      shift
      cmd_init "${1:-$DEFAULT_PORT}";;
    up|start)
      shift
      cmd_up "$@";;
    down|stop)
      shift
      cmd_down;;
    restart)
      shift
      cmd_down || true
      cmd_up "$@";;
    status)
      shift
      print_status;;
    logs)
      shift
      cmd_logs;;
    *)
      require_java
      ensure_cli_jar
      # encaminha para o CLI usando config local da pasta
      exec java -jar "$CLI_JAR" --config "$CONFIG_FILE" "$@";;
  esac
}

main "$@"
